<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PD ‚Äì DAN 121.605</title>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #eef1f4; margin: 0; }
header { background: #0b2d48; color: white; padding: 16px; text-align: center; }
nav { display: flex; }
nav button { flex: 1; padding: 14px; border: none; background: #d0d6dc; font-weight: 600; }
nav button.active { background: #ffffff; }
.container { padding: 16px; }
.card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
label { font-weight: 600; margin-top: 12px; display: block; }
input, select { width: 100%; padding: 10px; margin-top: 4px; border-radius: 8px; border: 1px solid #ccc; }
button.calc { background: #0b2d48; color: white; padding: 14px; border: none; border-radius: 10px; width: 100%; font-size: 16px; margin-top: 16px; cursor: pointer; }
.result { white-space: pre-line; font-size: 14px; margin-top: 16px; padding: 12px; border-radius: 8px; }
.success { background: #e6ffe6; border: 1px solid #28a745; }
.warning { background: #fff3cd; border: 1px solid #ffc107; }
.danger { background: #ffe6e6; border: 1px solid #dc3545; }
details { background: #f7f9fb; padding: 12px; border-radius: 10px; margin-bottom: 16px; }
details summary { font-weight: 700; cursor: pointer; }

/* Modal Normativa */
#normativaBtn { position: fixed; bottom: 30px; right: 30px; background: #0b2d48; color: white; border: none; border-radius: 50%; width: 70px; height: 70px; font-size: 13px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; }
.modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); overflow: auto; }
.modal-content { background: white; margin: 5% auto; padding: 25px; width: 85%; max-width: 900px; border-radius: 12px; max-height: 85vh; overflow-y: auto; }
.close { color: #aaa; float: right; font-size: 36px; font-weight: bold; cursor: pointer; }
.close:hover { color: #000; }
table { width: 100%; border-collapse: collapse; margin: 12px 0; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #f2f2f2; }
</style>
</head>

<body>

<header>
  <h2>Per√≠odo de Descanso ‚Äì DAN 121.605</h2>
  <small>ED 3 ¬∑ ENM 7 ¬∑ 02 ABR 2025 (versi√≥n corregida y validada)</small>
</header>

<nav>
  <button id="btnVuelo" class="active" onclick="switchView('vuelo')">Tripulaci√≥n de Vuelo</button>
  <button id="btnCabina" onclick="switchView('cabina')">Tripulaci√≥n de Cabina</button>
</nav>

<div class="container">

<div class="card">
<details>
<summary>üìò DAN 121.605 ‚Äì Consulta permanente</summary>
<p>Norma: DAN 121 ‚Äì Operaci√≥n de Aeronaves<br>
Numeral: 121.605<br>
Edici√≥n: ED 3 / ENM 7 (02 ABR 2025)<br>
Esta app valida PD seg√∫n tablas oficiales (b) vuelo y (c) cabina, con ajustes por longitud y traslados. Incluye validaci√≥n b√°sica de PSV m√°ximo.</p>
</details>
</div>

<!-- VUELO -->
<div id="vuelo" class="card">
<label>Tipo de Tripulaci√≥n</label>
<select id="tipoVuelo">
  <option value="2">2 Pilotos</option>
  <option value="3">3 Pilotos</option>
  <option value="4">4 Pilotos</option>
</select>

<label>Inicio PSV</label>
<input type="datetime-local" id="startV" required>

<label>T√©rmino PSV</label>
<input type="datetime-local" id="endV" required>

<label>¬øCambio ‚â• 45¬∞ longitud?</label>
<select id="lonV">
  <option value="no">No</option>
  <option value="si">S√≠</option>
</select>

<button class="calc" onclick="calcVuelo()">Calcular PD y Validar</button>
<div class="result" id="resV"></div>
</div>

<!-- CABINA -->
<div id="cabina" class="card" style="display:none">
<label>Tipo de Tripulaci√≥n</label>
<select id="tipoCabina">
  <option value="min">M√≠nima</option>
  <option value="ref">Reforzada</option>
</select>

<label>Inicio PSV</label>
<input type="datetime-local" id="startC" required>

<label>T√©rmino PSV</label>
<input type="datetime-local" id="endC" required>

<label>¬øCambio ‚â• 45¬∞ longitud?</label>
<select id="lonC">
  <option value="no">No</option>
  <option value="si">S√≠</option>
</select>

<button class="calc" onclick="calcCabina()">Calcular PD y Validar</button>
<div class="result" id="resC"></div>
</div>

</div>

<!-- Bot√≥n Normativa -->
<button id="normativaBtn">Normativa Completa</button>

<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>DAN 121.605 (ED3/ENM7 ABR 2025) - Extracto clave</h2>
    <h3>(b) Tripulantes de Vuelo - PD post-PSV</h3>
    <table>
      <tr><th>PSV (horas)</th><th>PD (horas)</th></tr>
      <tr><td>7 o menos</td><td>10</td></tr>
      <tr><td>8</td><td>12</td></tr>
      <tr><td>9</td><td>13</td></tr>
      <tr><td>10</td><td>14</td></tr>
      <tr><td>11-13</td><td>15</td></tr>
      <tr><td>14-15</td><td>17</td></tr>
      <tr><td>16</td><td>18</td></tr>
      <tr><td>17</td><td>19</td></tr>
      <tr><td>18</td><td>20</td></tr>
      <tr><td>19</td><td>22</td></tr>
      <tr><td>20</td><td>24</td></tr>
    </table>
    <p><strong>Ajustes:</strong> +2 h por cambio ‚â•45¬∞ longitud (+30 min por cada 15¬∞ adicional). Si PD=10 h: +45 min traslado base / +20 min postas (no cuenta como PD/PSV).</p>

    <h3>(c) Tripulantes de Cabina - PD post-PSV</h3>
    <table>
      <tr><th>PSV (horas)</th><th>PD (horas)</th></tr>
      <tr><td>7 o menos</td><td>10</td></tr>
      <tr><td>8</td><td>11</td></tr>
      <tr><td>9</td><td>12</td></tr>
      <tr><td>10</td><td>13</td></tr>
      <tr><td>11</td><td>14</td></tr>
      <tr><td>12</td><td>15</td></tr>
      <tr><td>13</td><td>16</td></tr>
      <tr><td>14</td><td>17</td></tr>
      <tr><td>15</td><td>18</td></tr>
      <tr><td>16</td><td>19</td></tr>
      <tr><td>17</td><td>20</td></tr>
      <tr><td>18</td><td>21</td></tr>
      <tr><td>19</td><td>22</td></tr>
      <tr><td>20</td><td>24</td></tr>
    </table>
    <p><strong>Ajustes:</strong> iguales a vuelo. PSV l√≠mites: M√≠nima 12 h (+2 ext.), Reforzada 20 h. Mensual 160 h, etc.</p>

    <p><em>Fuente: DAN 121 ED3/ENM7 (p√°gs. 121-124). Verifica siempre en dgac.gob.cl.</em></p>
  </div>
</div>

<script>
function switchView(v){
  document.getElementById('vuelo').style.display = v==="vuelo"?"block":"none";
  document.getElementById('cabina').style.display = v==="cabina"?"block":"none";
  document.getElementById('btnVuelo').classList.toggle("active",v==="vuelo");
  document.getElementById('btnCabina').classList.toggle("active",v==="cabina");
}

function horas(a,b){ return (new Date(b) - new Date(a)) / 3600000; }

// Modal control
const modal = document.getElementById("myModal");
const btn = document.getElementById("normativaBtn");
const span = document.getElementsByClassName("close")[0];
btn.onclick = () => modal.style.display = "block";
span.onclick = () => modal.style.display = "none";
window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

// Calc Vuelo
function calcVuelo(){
  const start = document.getElementById('startV').value;
  const end = document.getElementById('endV').value;
  if(!start || !end || new Date(end) <= new Date(start)){ 
    document.getElementById('resV').innerHTML = '<div class="danger">‚ùå Fechas inv√°lidas o t√©rmino antes de inicio.</div>'; 
    return; 
  }
  const psv = horas(start, end);
  const tipo = document.getElementById('tipoVuelo').value;
  const lon = document.getElementById('lonV').value === 'si';
  let maxPSV = tipo==='2'?12 : tipo==='3'?18 : 20;
  let pd = 0;
  let msgClass = 'success';
  let texto = `PSV calculado: ${psv.toFixed(2)} h\n`;

  // Validar PSV max
  if (psv > maxPSV + 2) { // +ext contingencia
    texto += '‚ùå PSV EXCEDE l√≠mite m√°ximo permitido.\n';
    msgClass = 'danger';
  } else if (psv > maxPSV) {
    texto += '‚ö†Ô∏è PSV en extensi√≥n (solo contingencias).\n';
    msgClass = 'warning';
  }

  // PD tabla vuelo
  if (psv <= 7) pd = 10;
  else if (psv <= 8) pd = 12;
  else if (psv <= 9) pd = 13;
  else if (psv <= 10) pd = 14;
  else if (psv <= 13) pd = 15;
  else if (psv <= 15) pd = 17;
  else if (psv <= 16) pd = 18;
  else if (psv <= 17) pd = 19;
  else if (psv <= 18) pd = 20;
  else if (psv <= 19) pd = 22;
  else if (psv <= 20) pd = 24;
  else {
    texto += '‚ùå PSV fuera de tabla (m√°x 20 h).\n';
    msgClass = 'danger';
  }

  if (lon) pd += 2; // +2 h base (nota progresiva)

  texto += `PD m√≠nimo aplicable: ${pd} h\n`;
  if (pd === 10) texto += 'Nota: Agregar traslados si aplica (+45 min base / +20 min postas, no cuenta como PD).\n';
  if (lon) texto += 'Nota: +2 h por ‚â•45¬∞ longitud (+30 min por cada 15¬∞ adicional seg√∫n norma).\n';

  texto += '\nNormativa: DAN 121.605(b) - Tabla PD y ajustes (iv)(E).';

  document.getElementById('resV').innerHTML = `<div class="${msgClass}">${texto}</div>`;
}

// Calc Cabina (similar)
function calcCabina(){
  const start = document.getElementById('startC').value;
  const end = document.getElementById('endC').value;
  if(!start || !end || new Date(end) <= new Date(start)){ 
    document.getElementById('resC').innerHTML = '<div class="danger">‚ùå Fechas inv√°lidas o t√©rmino antes de inicio.</div>'; 
    return; 
  }
  const psv = horas(start, end);
  const tipo = document.getElementById('tipoCabina').value;
  const lon = document.getElementById('lonC').value === 'si';
  let maxPSV = tipo==='min'?12 : 20;
  let pd = null;
  let msgClass = 'success';
  let texto = `PSV calculado: ${psv.toFixed(2)} h\n`;

  // Validar PSV max
  if (psv > maxPSV + (tipo==='min'?2:0)) {
    texto += '‚ùå PSV EXCEDE l√≠mite m√°ximo.\n';
    msgClass = 'danger';
  } else if (psv > maxPSV) {
    texto += '‚ö†Ô∏è PSV en extensi√≥n (solo m√≠nima).\n';
    msgClass = 'warning';
  }

  // Tabla cabina
  const tabla = [7,8,9,10,11,12,13,14,15,16,17,18,19,20];
  const pds = [10,11,12,13,14,15,16,17,18,19,20,21,22,24];
  for (let i=0; i<tabla.length; i++){
    if (psv <= tabla[i]) { pd = pds[i]; break; }
  }
  if (pd === null) {
    texto += '‚ùå PSV fuera de tabla (m√°x 20 h).\n';
    msgClass = 'danger';
  }

  if (lon) pd += 2;

  texto += `PD m√≠nimo aplicable: ${pd} h\n`;
  if (pd === 10) texto += 'Nota: Agregar traslados si aplica (+45 min base / +20 min postas).\n';
  if (lon) texto += 'Nota: +2 h por ‚â•45¬∞ longitud (+30 min por cada 15¬∞ adicional).\n';

  texto += '\nNormativa: DAN 121.605(c) - Tabla PD y ajustes (iv).';

  document.getElementById('resC').innerHTML = `<div class="${msgClass}">${texto}</div>`;
}
</script>

</body>
</html>

