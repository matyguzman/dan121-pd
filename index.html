<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PD – DAN 121.605</title>

<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #eef1f4; margin: 0; }
header { background: #0b2d48; color: white; padding: 16px; text-align: center; }
nav { display: flex; }
nav button { flex: 1; padding: 14px; border: none; background: #d0d6dc; font-weight: 600; cursor: pointer; }
nav button.active { background: #ffffff; }
.container { padding: 16px; }
.card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
label { font-weight: 600; margin-top: 12px; display: block; }
input, select { width: 100%; padding: 10px; margin-top: 4px; border-radius: 8px; border: 1px solid #ccc; }
button.calc { background: #0b2d48; color: white; padding: 14px; border: none; border-radius: 10px; width: 100%; font-size: 16px; margin-top: 16px; cursor: pointer; }
.result { white-space: pre-line; font-size: 14px; margin-top: 16px; padding: 12px; border-radius: 8px; }
.success { background: #e6ffe6; border: 1px solid #28a745; }
.warning { background: #fff3cd; border: 1px solid #ffc107; }
.danger { background: #ffe6e6; border: 1px solid #dc3545; }
</style>
</head>

<body>

<header>
  <h2>Período de Descanso – DAN 121.605 · ED 3 · ENM 7 · 02 ABR 2025</h2>
  <small>SÓLO PARA REFERENCIA · ¡RECUERDA SIEMPRE CONSULTAR LA NORMATIVA VIGENTE Y TU MANUAL DE OPERACIONES!</small>
</header>

<nav>
  <button id="btnVuelo" class="active" onclick="switchView('vuelo')">Tripulación de Vuelo</button>
  <button id="btnCabina" onclick="switchView('cabina')">Tripulación de Cabina</button>
</nav>

<div class="container">

  <!-- Tripulación de Vuelo -->
  <div id="vuelo" class="card">
    <label>Tipo de Tripulación</label>
    <select id="tipoVuelo">
      <option value="2">2 Pilotos</option>
      <option value="3">3 Pilotos</option>
      <option value="4">4 Pilotos</option>
    </select>

    <label>Inicio PSV</label>
    <input type="datetime-local" id="startV" required>

    <label>Término PSV</label>
    <input type="datetime-local" id="endV" required>

    <label>¿Cambio ≥ 45° longitud?</label>
    <select id="lonV">
      <option value="no">No</option>
      <option value="si">Sí</option>
    </select>

    <button class="calc" onclick="calcVuelo()">Calcular PD y Validar</button>
    <div class="result" id="resV"></div>
  </div>

  <!-- Tripulación de Cabina -->
  <div id="cabina" class="card" style="display:none">
    <label>Tipo de Tripulación</label>
    <select id="tipoCabina">
      <option value="min">Mínima</option>
      <option value="ref">Reforzada</option>
    </select>

    <label>Inicio PSV</label>
    <input type="datetime-local" id="startC" required>

    <label>Término PSV</label>
    <input type="datetime-local" id="endC" required>

    <label>¿Cambio ≥ 45° longitud?</label>
    <select id="lonC">
      <option value="no">No</option>
      <option value="si">Sí</option>
    </select>

    <button class="calc" onclick="calcCabina()">Calcular PD y Validar</button>
    <div class="result" id="resC"></div>
  </div>

</div>

<script>
// Switch entre pestañas (solo dos)
function switchView(v) {
  document.getElementById('vuelo').style.display = v === 'vuelo' ? 'block' : 'none';
  document.getElementById('cabina').style.display = v === 'cabina' ? 'block' : 'none';

  document.getElementById('btnVuelo').classList.toggle('active', v === 'vuelo');
  document.getElementById('btnCabina').classList.toggle('active', v === 'cabina');
}

// Cálculo horas
function horas(a, b) { return (new Date(b) - new Date(a)) / 3600000; }

// % nocturno preciso (por minuto)
function calculateNocturnalHours(startStr, endStr) {
  const start = new Date(startStr);
  const end = new Date(endStr);
  let nocturnal = 0;
  let current = new Date(start);
  while (current < end) {
    const next = new Date(current.getTime() + 60000);
    if (next > end) next = end;
    const hour = current.getHours();
    if (hour >= 21 || hour < 6) nocturnal += (next - current) / 3600000;
    current = next;
  }
  return nocturnal;
}

// calcVuelo (completo)
function calcVuelo() {
  const startStr = document.getElementById('startV').value;
  const endStr = document.getElementById('endV').value;
  if (!startStr || !endStr || new Date(endStr) <= new Date(startStr)) {
    document.getElementById('resV').innerHTML = '<div class="danger">❌ Fechas inválidas o término antes de inicio.</div>';
    return;
  }
  const psv = horas(startStr, endStr);
  const tipo = document.getElementById('tipoVuelo').value;
  const lon = document.getElementById('lonV').value === 'si';
  const startDate = new Date(startStr);
  const endDate = new Date(endStr);
  const startHour = startDate.getHours();
  let maxPSV = tipo === '2' ? 12 : tipo === '3' ? 18 : 20;
  let pd = 0;
  let msgClass = 'success';
  let texto = `PSV: ${psv.toFixed(2)} h\nInicio: ${startDate.toLocaleString('es-CL')}\nTérmino: ${endDate.toLocaleString('es-CL')}\n`;

  if (startHour >= 21 || startHour < 6) texto += '⚠️ Inicio en rango nocturno (asumiendo aprobación).\n';

  const nocturnal = calculateNocturnalHours(startStr, endStr);
  const percent = psv > 0 ? (nocturnal / psv * 100) : 0;
  texto += `Nocturno: ${nocturnal.toFixed(2)} h (${percent.toFixed(1)}%)\n`;
  if (percent > 50) texto += '⚠️ >50% nocturno → Solo un segundo PSV nocturno consecutivo, ≤50% nocturno (121.605(b)(2)(v)).\n';

  if (psv > maxPSV + 2) { texto += '❌ Excede máximo.\n'; msgClass = 'danger'; }
  else if (psv > maxPSV) { texto += '⚠️ En extensión.\n'; msgClass = 'warning'; }

  if (psv <= 7) pd = 10;
  else if (psv <= 8) pd = 12;
  else if (psv <= 9) pd = 13;
  else if (psv <= 10) pd = 14;
  else if (psv <= 13) pd = 15;
  else if (psv <= 15) pd = 17;
  else if (psv <= 16) pd = 18;
  else if (psv <= 17) pd = 19;
  else if (psv <= 18) pd = 20;
  else if (psv <= 19) pd = 22;
  else if (psv <= 20) pd = 24;
  else { texto += '❌ Fuera de tabla.\n'; msgClass = 'danger'; }

  if (lon) pd += 2;

  texto += `PD mínimo: ${pd} h\nFin PD (inicio próximo): ${new Date(endDate.getTime() + pd * 3600000).toLocaleString('es-CL')}\n`;
  if (pd === 10) texto += 'Nota: +45 min base / +20 min postas si aplica.\n';
  if (lon) texto += 'Nota: +2 h por ≥45° longitud (+30 min cada 15° adicional).\n';

  document.getElementById('resV').innerHTML = `<div class="${msgClass}">${texto}</div>`;
}

// calcCabina (completo)
function calcCabina() {
  const startStr = document.getElementById('startC').value;
  const endStr = document.getElementById('endC').value;
  if (!startStr || !endStr || new Date(endStr) <= new Date(startStr)) {
    document.getElementById('resC').innerHTML = '<div class="danger">❌ Fechas inválidas o término antes de inicio.</div>';
    return;
  }
  const psv = horas(startStr, endStr);
  const tipo = document.getElementById('tipoCabina').value;
  const lon = document.getElementById('lonC').value === 'si';
  const startDate = new Date(startStr);
  const endDate = new Date(endStr);
  const startHour = startDate.getHours();
  let maxPSV = tipo === 'min' ? 12 : 20;
  let pd = null;
  let msgClass = 'success';
  let texto = `PSV: ${psv.toFixed(2)} h\nInicio: ${startDate.toLocaleString('es-CL')}\nTérmino: ${endDate.toLocaleString('es-CL')}\n`;

  if (startHour >= 21 || startHour < 6) texto += '⚠️ Inicio nocturno (verifica operador).\n';

  const nocturnal = calculateNocturnalHours(startStr, endStr);
  const percent = psv > 0 ? (nocturnal / psv * 100) : 0;
  texto += `Nocturno: ${nocturnal.toFixed(2)} h (${percent.toFixed(1)}%)\n`;
  if (percent > 50) texto += '⚠️ >50% nocturno → Solo un segundo PSV nocturno consecutivo, ≤50% nocturno.\n';

  if (psv > maxPSV + (tipo === 'min' ? 2 : 0)) { texto += '❌ Excede máximo.\n'; msgClass = 'danger'; }
  else if (psv > maxPSV) { texto += '⚠️ En extensión.\n'; msgClass = 'warning'; }

  const tabla = [7,8,9,10,11,12,13,14,15,16,17,18,19,20];
  const pds = [10,11,12,13,14,15,16,17,18,19,20,21,22,24];
  for (let i = 0; i < tabla.length; i++) {
    if (psv <= tabla[i]) { pd = pds[i]; break; }
  }
  if (pd === null) { texto += '❌ Fuera de tabla.\n'; msgClass = 'danger'; }

  if (lon) pd += 2;

  texto += `PD mínimo: ${pd} h\nFin PD: ${new Date(endDate.getTime() + pd * 3600000).toLocaleString('es-CL')}\n`;
  if (pd === 10) texto += 'Nota traslados.\n';
  if (lon) texto += 'Nota longitud.\n';

  document.getElementById('resC').innerHTML = `<div class="${msgClass}">${texto}</div>`;
}
</script>

</body>
</html>
